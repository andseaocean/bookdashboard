<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tab.active {
            background: white;
            color: #11998e;
            font-weight: bold;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #11998e;
            font-size: 1.8em;
            font-weight: bold;
        }

        .credit-display {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .credit-number {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
        }

        .credit-message {
            font-size: 1.2em;
            margin-top: 10px;
        }

        .section-title {
            color: #11998e;
            margin: 30px 0 20px 0;
            text-align: center;
            font-size: 1.5em;
        }

        .subsection-title {
            color: #666;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
        }

        /* –†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä */
        .controls {
            margin-bottom: 25px;
        }

        .slider-container {
            margin-bottom: 25px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #555;
            font-weight: 500;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #11998e;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #11998e;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .filter-select:hover {
            border-color: #11998e;
        }

        .filter-select:focus {
            outline: none;
            border-color: #11998e;
        }

        .action-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: transform 0.2s;
            font-weight: 600;
        }

        .action-btn:hover {
            transform: scale(1.02);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .book-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .book-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.3);
        }

        .book-cover {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            flex-shrink: 0;
        }

        .book-info {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .book-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #11998e;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .book-author {
            color: #666;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .book-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: #999;
            flex-wrap: wrap;
        }

        .book-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* –ü–æ—Ä–∞–¥–Ω–∏–∫ */
        .input-area {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: #11998e;
        }

        .recommendation-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            color: #11998e;
            padding: 40px 20px;
            font-size: 18px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            
            .books-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="tab" onclick="switchTab('randomizer')">üé≤ –†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä</button>
            <button class="tab" onclick="switchTab('advisor')">üí° –ü–æ—Ä–∞–¥–Ω–∏–∫</button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="stats" class="content-section active">
            <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">–í—Å—å–æ–≥–æ –∫–Ω–∏–∂–æ–∫</div>
                    <div class="stat-value" id="totalBooks">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
                    <div class="stat-value" id="readBooks">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
                    <div class="stat-value" id="unreadBooks">-</div>
                </div>
            </div>

            <!-- –ö–Ω–∏–∂–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å -->
            <div class="credit-display">
                <h2>–¢–≤—ñ–π –∫–Ω–∏–∂–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å</h2>
                <div class="credit-number" id="creditNumber">-</div>
                <div class="credit-message" id="creditMessage">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            </div>
        </div>

        <!-- –†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä -->
        <div id="randomizer" class="content-section">
            <div class="controls">
                <div class="slider-container">
                    <div class="slider-label">
                        <span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–Ω–∏–∂–æ–∫:</span>
                        <strong id="bookCountDisplay">1</strong>
                    </div>
                    <input 
                        type="range" 
                        min="1" 
                        max="5" 
                        value="1" 
                        class="slider" 
                        id="bookCountSlider"
                    >
                </div>

                <div class="filters-container">
                    <div class="filter-group">
                        <label class="filter-label">–ú–æ–≤–∞</label>
                        <select class="filter-select" id="languageFilter">
                            <option value="">–ë—É–¥—å-—è–∫–∞</option>
                            <option value="–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                            <option value="–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞">–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">–§–æ—Ä–º–∞—Ç</label>
                        <select class="filter-select" id="formatFilter">
                            <option value="">–ë—É–¥—å-—è–∫–∏–π</option>
                            <option value="–ü–∞–ø–µ—Ä–æ–≤–∞">–ü–∞–ø–µ—Ä–æ–≤–∞</option>
                            <option value="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞">–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="action-btn" onclick="getRandomBooks()" id="randomizeBtn">
                üé≤ –í–∏–±—Ä–∞—Ç–∏ –≤–∏–ø–∞–¥–∫–æ–≤—ñ –∫–Ω–∏–≥–∏
            </button>
            
            <div id="randomBookResult" class="books-grid"></div>
        </div>

        <!-- –ü–æ—Ä–∞–¥–Ω–∏–∫ -->
        <div id="advisor" class="content-section">
            <div class="input-area">
                <textarea 
                    id="requestInput" 
                    placeholder="–ù–∞–ø–∏—à–∏, —â–æ —Ö–æ—á–µ—à –ø—Ä–æ—á–∏—Ç–∞—Ç–∏... –ù–∞–ø—Ä–∏–∫–ª–∞–¥: '–•–æ—á—É —â–æ—Å—å –∑–≤–æ—Ä—É—à–ª–∏–≤–µ' –∞–±–æ '–©–æ —Å—Ö–æ–∂–µ –Ω–∞ [–Ω–∞–∑–≤–∞ –∫–Ω–∏–≥–∏]?'"
                ></textarea>
            </div>
            
            <button class="action-btn" onclick="getRecommendation()" id="advisorBtn">
                üí° –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ä–∞–¥—É
            </button>
            
            <div id="recommendationResult"></div>
        </div>
    </div>

    <script>
        // –í–ê–ñ–õ–ò–í–û: –ó–∞–º—ñ–Ω—ñ—Ç—å —Ü–µ –Ω–∞ URL –≤–∞—à–æ–≥–æ Cloudflare Worker!
        const API_URL = 'https://bookdashboard.meereundozeane.workers.dev';

        // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'stats') {
                loadStatsData();
            }
        }

        // –°–ª–∞–π–¥–µ—Ä –¥–ª—è —Ä–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä–∞
        const slider = document.getElementById('bookCountSlider');
        const display = document.getElementById('bookCountDisplay');
        
        slider.addEventListener('input', function() {
            display.textContent = this.value;
        });

        // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        function getPropertyValue(property) {
            if (!property) return '';
            
            switch (property.type) {
                case 'title':
                    return property.title.map(t => t.plain_text).join('');
                case 'rich_text':
                    return property.rich_text.map(t => t.plain_text).join('');
                case 'select':
                    return property.select?.name || '';
                case 'date':
                    return property.date?.start || '';
                case 'files':
                    if (property.files && property.files.length > 0) {
                        return property.files[0].file?.url || property.files[0].external?.url || '';
                    }
                    return '';
                default:
                    return '';
            }
        }

        function getCoverUrl(book) {
            const coverProperty = book.properties['–û–±–∫–ª–∞–¥–∏–Ω–∫–∞'];
            if (coverProperty?.files?.[0]) {
                return coverProperty.files[0].file?.url || coverProperty.files[0].external?.url || '';
            }
            if (book.cover) {
                return book.cover.file?.url || book.cover.external?.url || '';
            }
            return '';
        }

        function renderBookCard(book) {
            const title = getPropertyValue(book.properties['–ù–∞–∑–≤–∞ –∫–Ω–∏–∂–∫–∏']) || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
            const author = getPropertyValue(book.properties['–ê–≤—Ç–æ—Ä(–∫–∞)']) || '–ê–≤—Ç–æ—Ä –Ω–µ–≤—ñ–¥–æ–º–∏–π';
            const coverUrl = getCoverUrl(book);
            
            return `
                <a href="${book.url}" target="_blank" class="book-card-link">
                    <div class="book-card">
                        ${coverUrl ? 
                            `<img src="${coverUrl}" alt="${title}" class="book-cover">` :
                            `<div class="book-cover" style="display: flex; align-items: center; justify-content: center; color: white; font-size: 3em;">üìö</div>`
                        }
                        <div class="book-info">
                            <div class="book-title">${title}</div>
                            <div class="book-author">${author}</div>
                        </div>
                    </div>
                </a>
            `;
        }

        // 1. –°–¢–ê–¢–ò–°–¢–ò–ö–ê
        async function loadStatsData() {
            const creditNumber = document.getElementById('creditNumber');
            const creditMessage = document.getElementById('creditMessage');
            const totalBooks = document.getElementById('totalBooks');
            const readBooks = document.getElementById('readBooks');
            const unreadBooks = document.getElementById('unreadBooks');

            try {
                creditNumber.textContent = '...';
                creditMessage.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...';

                const response = await fetch(API_URL + '/tracking');

                if (!response.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
                }

                const data = await response.json();
                const cutoffDate = new Date('2025-06-30');

                // –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                totalBooks.textContent = data.results.length;
                
                const readCount = data.results.filter(book => {
                    const status = getPropertyValue(book.properties['–°—Ç–∞—Ç—É—Å']);
                    return status === '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ';
                }).length;
                
                readBooks.textContent = readCount;
                unreadBooks.textContent = data.results.length - readCount;

                // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è –±–∞–ª–∞–Ω—Å—É
                const booksReadAfterCutoff = data.results.filter(book => {
                    const readDate = getPropertyValue(book.properties['–ü—Ä–æ—á–∏—Ç–∞–Ω–æ']);
                    return readDate && new Date(readDate) > cutoffDate;
                }).length;

                const booksBoughtAfterCutoff = data.results.filter(book => {
                    const boughtDate = getPropertyValue(book.properties['–ö—É–ø–ª–µ–Ω–æ']);
                    return boughtDate && new Date(boughtDate) > cutoffDate;
                }).length;

                const balance = Math.floor(booksReadAfterCutoff / 2) - booksBoughtAfterCutoff;

                // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É
                creditNumber.textContent = balance;
                
                if (balance < 0) {
                    const debt = Math.abs(balance);
                    const remainder = booksReadAfterCutoff % 2; // –ó–∞–ª–∏—à–æ–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö –∫–Ω–∏–≥
                    const needToRead = debt * 2 + 2 - remainder;
                    creditMessage.textContent = `–¢–∏ —É –∫–Ω–∏–∂–∫–æ–≤–æ–º—É –∫—Ä–µ–¥–∏—Ç—ñ. –©–æ–± –∫—É–ø–∏—Ç–∏ –Ω–æ–≤—É –∫–Ω–∏–∂–∫—É, —Ç–æ–±—ñ —Ç—Ä–µ–±–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —â–µ ${needToRead} ${needToRead === 1 ? '–∫–Ω–∏–≥—É' : needToRead < 5 ? '–∫–Ω–∏–≥–∏' : '–∫–Ω–∏–∂–æ–∫'} —ñ–∑ —Ç–∏—Ö, —è–∫—ñ —Ç–∏ –º–∞—î—à.`;
                } else if (balance === 0) {
                    const remainder = booksReadAfterCutoff % 2; // –ó–∞–ª–∏—à–æ–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö –∫–Ω–∏–≥
                    const needToRead = 2 - remainder;
                    creditMessage.textContent = `–¢–≤—ñ–π –±–∞–ª–∞–Ω—Å –Ω—É–ª—å–æ–≤–∏–π. –ü—Ä–æ—á–∏—Ç–∞–π —â–µ ${needToRead} ${needToRead === 1 ? '–∫–Ω–∏–≥—É' : '–∫–Ω–∏–≥–∏'}, —â–æ–± –∫—É–ø–∏—Ç–∏ –Ω–æ–≤—É! üìö`;
                } else {
                    creditMessage.textContent = `–¢–∏ –º–æ–∂–µ—à –∫—É–ø–∏—Ç–∏ ${balance} ${balance === 1 ? '–∫–Ω–∏–≥—É' : balance < 5 ? '–∫–Ω–∏–≥–∏' : '–∫–Ω–∏–∂–æ–∫'}! üéâ`;
                }

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                creditNumber.textContent = '‚ùå';
                creditMessage.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö';
            }
        }

        // 2. –†–ê–ù–î–û–ú–ê–ô–ó–ï–†
        async function getRandomBooks() {
            const button = document.getElementById('randomizeBtn');
            const resultDiv = document.getElementById('randomBookResult');
            const count = parseInt(document.getElementById('bookCountSlider').value);
            const language = document.getElementById('languageFilter').value;
            const format = document.getElementById('formatFilter').value;

            button.disabled = true;
            resultDiv.innerHTML = '<div class="loading">üé≤ –®—É–∫–∞—é –∫–Ω–∏–≥–∏...</div>';

            try {
                let url = API_URL + '/randomizer?count=' + count;
                if (language) url += '&language=' + encodeURIComponent(language);
                if (format) url += '&format=' + encodeURIComponent(format);

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–Ω–∏–≥');
                }

                const books = await response.json();

                if (books.length === 0) {
                    resultDiv.innerHTML = '<div class="loading">üòî –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–Ω–∏–≥ –∑ —Ç–∞–∫–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏</div>';
                    return;
                }

                resultDiv.innerHTML = books.map(book => {
                    const title = getPropertyValue(book.properties['–ù–∞–∑–≤–∞ –∫–Ω–∏–∂–∫–∏']) || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
                    const author = getPropertyValue(book.properties['–ê–≤—Ç–æ—Ä(–∫–∞)']) || '–ê–≤—Ç–æ—Ä –Ω–µ–≤—ñ–¥–æ–º–∏–π';
                    const bookLanguage = getPropertyValue(book.properties['–ú–æ–≤–∞']);
                    const bookFormat = getPropertyValue(book.properties['–§–æ—Ä–º–∞—Ç']);
                    const coverUrl = getCoverUrl(book);

                    return `
                        <a href="${book.url}" target="_blank" class="book-card-link">
                            <div class="book-card">
                                ${coverUrl ? 
                                    `<img src="${coverUrl}" alt="${title}" class="book-cover">` :
                                    `<div class="book-cover" style="display: flex; align-items: center; justify-content: center; color: white; font-size: 3em;">üìö</div>`
                                }
                                <div class="book-info">
                                    <div class="book-title">${title}</div>
                                    <div class="book-author">${author}</div>
                                    <div class="book-meta">
                                        ${bookLanguage ? `<span>üåç ${bookLanguage}</span>` : ''}
                                        ${bookFormat ? `<span>üìñ ${bookFormat}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                resultDiv.innerHTML = '<div class="error">‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–Ω–∏–≥</div>';
            } finally {
                button.disabled = false;
            }
        }

        // 3. –ü–û–†–ê–î–ù–ò–ö
        async function getRecommendation() {
            const button = document.getElementById('advisorBtn');
            const resultDiv = document.getElementById('recommendationResult');
            const request = document.getElementById('requestInput').value.trim();

            if (!request) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–ø–∏—à–∏, —â–æ —Ç–∏ —Ö–æ—á–µ—à –ø—Ä–æ—á–∏—Ç–∞—Ç–∏!');
                return;
            }

            button.disabled = true;
            button.textContent = '‚è≥ –î—É–º–∞—é...';
            resultDiv.innerHTML = '<div class="loading">ü§î –ê–Ω–∞–ª—ñ–∑—É—é —Ç–≤–æ—é –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É...</div>';

            try {
                const response = await fetch(API_URL + '/advisor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ request: request })
                });

                if (!response.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π');
                }

                const data = await response.json();

                // –ë–µ—Ä–µ–º–æ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—ñ 3 –∫–Ω–∏–≥–∏
                const recommendedBooks = data.books.slice(0, 3);
                
                // –í–∏—Ç—è–≥—É—î–º–æ –ø–æ—è—Å–Ω–µ–Ω–Ω—è –∑ —Ç–µ–∫—Å—Ç—É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
                const explanations = [];
                const recommendation = data.recommendation;
                
                // –†–æ–∑–±–∏–≤–∞—î–º–æ –Ω–∞ —Å–µ–∫—Ü—ñ—ó (1. ... 2. ... 3. ...)
                const sections = recommendation.split(/\n?\d+\.\s+/).filter(s => s.trim());
                
                // –î–ª—è –∫–æ–∂–Ω–æ—ó —Å–µ–∫—Ü—ñ—ó –≤–∏—Ç—è–≥—É—î–º–æ –ø–æ—è—Å–Ω–µ–Ω–Ω—è (–≤—Å–µ –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ —Ä—è–¥–∫–∞)
                sections.forEach(section => {
                    const lines = section.split('\n').filter(l => l.trim());
                    // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ (–Ω–∞–∑–≤–∞), –±–µ—Ä–µ–º–æ —Ä–µ—à—Ç—É
                    const explanation = lines.slice(1).join(' ').trim();
                    if (explanation) {
                        explanations.push(explanation);
                    }
                });

                if (recommendedBooks.length > 0) {
                    resultDiv.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            ${recommendedBooks.map((book, index) => `
                                <a href="${book.url}" target="_blank" style="text-decoration: none; color: inherit;">
                                    <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;" 
                                         onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                                        
                                        <div style="display: flex; gap: 20px; margin-bottom: 16px;">
                                            ${book.coverUrl ? 
                                                `<img src="${book.coverUrl}" alt="${book.title}" style="width: 120px; height: 160px; object-fit: cover; border-radius: 8px; flex-shrink: 0;">` :
                                                `<div style="width: 120px; height: 160px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 3em; flex-shrink: 0;">üìö</div>`
                                            }
                                            <div style="flex: 1;">
                                                <h3 style="font-size: 1.5em; font-weight: bold; color: #1a1a1a; margin: 0 0 8px 0; line-height: 1.3;">
                                                    ${book.title}
                                                </h3>
                                                <p style="font-size: 1em; color: #666; margin: 0;">
                                                    ${book.author}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        ${explanations[index] ? 
                                            `<div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 16px; border-radius: 8px;">
                                                <div style="font-weight: 600; color: #059669; margin-bottom: 8px; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px;">
                                                    –ß–æ–º—É —Ü–µ —Ç–æ–±—ñ –ø—ñ–¥—ñ–π–¥–µ
                                                </div>
                                                <div style="color: #1a1a1a; line-height: 1.6; font-size: 0.95em;">
                                                    ${explanations[index]}
                                                </div>
                                            </div>` 
                                            : ''
                                        }
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="recommendation-box">
                            –ù–∞ –∂–∞–ª—å, –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –∫–Ω–∏–≥–∏ –≤ —Ç–≤–æ—ó–π –±–∞–∑—ñ. –°–ø—Ä–æ–±—É–π —ñ–Ω—à–∏–π –∑–∞–ø–∏—Ç –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä, —á–∏ —î –∫–Ω–∏–≥–∏ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º "–î–∞–ª–µ–∫—ñ –ø–ª–∞–Ω–∏".
                        </div>
                    `;
                }

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                resultDiv.innerHTML = '<div class="error">‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π</div>';
            } finally {
                button.disabled = false;
                button.textContent = 'üí° –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ä–∞–¥—É';
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('load', function() {
            loadStatsData();
        });
    </script>
</body>
</html>
